---
title: "Evaluating weighted regression half-window widths"
output: 
  flexdashboard::flex_dashboard
runtime: shiny
---
  
```{r, warning = F, message = F, echo = F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = F)

library(shiny)
library(tidyverse)
library(lubridate)
library(WtRegDO)
library(patchwork)
library(ShinyDash)
library(shinydashboard)
library(flexdashboard)
library(RColorBrewer)
```

```{r reactives}
# metab observed data 
metobsdat <- reactive({
  
  # inputs
  site <- input$site
  months <- input$months
  day <- input$day
  hour <- input$hour
  tide <- input$tide
  
  months <- seq(months[1], months[2])
    
  flnm <- paste('metobs', site, day, hour, tide, sep = '_')
  load(file = paste0('data/', flnm, '.RData'))
  dat <- get(flnm) %>% 
    na.omit() %>% 
    filter(month(Date) %in% months)
  
  return(dat)
  
})
  
# metab detided data 
metdtddat <- reactive({
  
  # inputs
  site <- input$site
  months <- input$months
  day <- input$day
  hour <- input$hour
  tide <- input$tide
  
  months <- seq(months[1], months[2])
  
  flnm <- paste('metdtd', site, day, hour, tide, sep = '_')
  load(file = paste0('data/', flnm, '.RData'))
  dat <- get(flnm) %>% 
    na.omit() %>% 
    filter(month(Date) %in% months)
  
  return(dat)
  
})
  
# obsserved data
obsdat <- reactive({
  
  # inputs
  site <- input$site
  months <- input$months
  day <- input$day
  hour <- input$hour
  tide <- input$tide
    
  months <- seq(months[1], months[2])
  
  flnm <- paste('DO', site, day, hour, tide, sep = '_')
  load(file = paste0('data/', flnm, '.RData'))
  dat <- get(flnm) %>% 
    filter(month(DateTimeStamp) %in% months)
  
  return(dat)
  
})

# detided, observed eval data
evaldat <- reactive({
  
  # input
  metdtddat <- metdtddat()
  metobsdat <- metobsdat()

  evalobs <- meteval(metobsdat)
  evaldtd <- meteval(metdtddat)

  out <- list(Observed = evalobs, Detided = evaldtd)
  
  return(out)
  
})

# detided, observed correlation data
evalcorr <- reactive({
  
  # input
  evaldat <- evaldat()
  months <- input$months
  
  months <- seq(months[1], months[2])
   
  out <- evaldat %>% 
    enframe('set', 'corr') %>% 
    mutate(
      corr = purrr::map(corr, function(x){

        docorr <- x %>% 
          .[c('DOcor.month', 'DOcor.cor')] %>% 
          data.frame %>% 
          rename(month = DOcor.month, DOcor = DOcor.cor)
          
        metcorr <- x %>% 
          .[c('month', 'Pgcor', 'Rtcor')] %>% 
          data.frame 
        
        out <- full_join(docorr, metcorr, by = 'month') %>% 
          gather('var', 'val', -month)
        
        return(out)
      
      })
    ) %>% 
    unnest('corr') %>% 
    mutate(month = as.numeric(month)) %>% 
    dplyr::filter(month %in% months) %>% 
    mutate(
      month = factor(month, levels = sort(as.numeric(months))), 
      var = factor(var, levels = c('DOcor', 'Pgcor', 'Rtcor'), labels = c('DO', 'Pg', 'Rt')), 
      set = factor(set, levels = c('Observed', 'Detided'))
      )

  return(out)
  
})

# correlation plot
corplo <- reactive({

  # input
  evalcorr <- evalcorr()

  validate(
    need(nrow(evalcorr) > 0, "Insufficient data")
  )
  
  toplo <- evalcorr
  
  p <- ggplot(toplo, aes(x = month, y = val, group = set, colour = set)) + 
    geom_line() +
    geom_point() + 
    geom_hline(yintercept = 0, linetype = 'dashed') + 
    facet_grid( ~ var) + 
    scale_x_discrete(drop = F) + 
    scale_y_continuous(limits = c(-1, 1)) +
    ylab('Correlation with tide') +
    xlab('Month') +
    theme_bw() +
    theme(text = element_text(size=18), 
      legend.position = 'top',
      legend.direction = 'horizontal',
      legend.title = element_blank()
      )
  
  print(p)
  
  })

# metabolism plot
metplo <- reactive({
  
  # input
  metdtddat <- metdtddat()
  metobsdat <- metobsdat()
  obsdat <- obsdat()
  months <- input$months
  
  validate(
    need(nrow(metdtddat) > 0, "Insufficient data")
  )

  # x axix limits
  yr <- metobsdat$Date %>% 
    year %>% 
    unique
  xlims <- paste(months, c(1, 31), sep = '-') %>% 
    paste(yr, ., sep = '-') %>% 
    ymd()
  
  toplo <- obsdat %>% 
    select(DateTimeStamp, DO_obs, DO_nrm) %>% 
    gather('var', 'val', -DateTimeStamp) %>% 
    mutate(var = factor(var, levels = c('DO_obs', 'DO_nrm'), labels = c('Observed', 'Detided')))

  p1 <- plot(metobsdat, by = 'days') +
    ggtitle('Observed results') + 
    theme(legend.position = 'none') + 
    scale_x_date(limits = xlims)
  
  p2 <- plot(metdtddat, by = 'days') + 
    ggtitle('Detided results') + 
    theme(legend.position = 'top') + 
    scale_x_date(limits = xlims)
  
  p3 <- ggplot(toplo, aes(x = DateTimeStamp, y = val, colour = var)) + 
    geom_line() + 
    theme_bw() + 
    labs(y = 'DO (mg/l)') +
    theme(
      legend.position = 'top', 
      legend.title = element_blank()
    ) + 
    scale_x_datetime(limits = as.POSIXct(xlims))
  
  p4 <- ggplot(obsdat, aes(x = DateTimeStamp, y = Tide, colour = Sal)) + 
    geom_line() + 
    theme_bw() + 
    scale_colour_gradientn(name = 'Salinity (psu)', 
      colours = rev(brewer.pal(7, 'Spectral'))
      ) +
    labs(y = 'Tide (m)') +
    theme(
      legend.position = 'top'
    ) + 
    scale_x_datetime(limits = as.POSIXct(xlims))
  
  p1 + p2 + p3 + p4 + plot_layout(ncol = 1)
  
})

# anomalous table
anotab <- reactive({
  
  # input
  evaldat <- evaldat()
  months <- input$months
  
  months <- seq(months[1], months[2])
  
  out <- evaldat %>% 
    enframe('set', 'anom') %>% 
    mutate(
      anom = purrr::map(anom, function(x){

        out <- x %>% 
          .[c('meanPg', 'sdPg', 'anomPg', 'meanRt', 'sdRt', 'anomRt')] %>% 
          data.frame 
        
        names(out) <- c('Pg Mean', 'Pg SD', 'Pg Anom', 'Rt Mean', 'Rt SD', 'Rt Anom')
        
        return(out)
      
      })
    ) %>% 
    unnest('anom') %>% 
    mutate(
      set = factor(set, levels = c('Observed', 'Detided'))
      ) %>% 
    rename(Input = set) %>% 
    na.omit()

  validate(
    need(nrow(out) > 0, 'Insufficient data')
  )
  
  return(out)
  
})

# correlation table
cortab <- reactive({
  
  # input
  evalcorr <- evalcorr()
  
  validate(
    need(nrow(evalcorr) > 0, "Insufficient data")
  )
  
  out <- evalcorr %>% 
    spread(var, val) %>% 
    select(Month = month, Input = set, everything()) %>% 
    arrange(Month, Input) %>% 
    mutate(Month = ifelse(duplicated(Month), '', as.character(Month)))
  
  return(out)
  
})
```


Inputs {.sidebar}
-------------------------------------

```{r ui}
column(12, 
  selectInput('site', label = 'Select site',  choices = c('APNERR', 'SAPDC'))
)
column(12, 
  sliderInput('months', 'Select months', min = 1, max = 12, step = 1, value = c(1, 12))
)
column(12, 
  radioButtons('day', label = h3('Day'), choices = list('one' = 1, 'three' = 3, 'six' = 6, 'nine' = 9, 'twelve' = 12))
)
column(12, 
  radioButtons('hour', label = h3('Hour'), choices = list('one' = 1, 'three' = 3, 'six' = 6, 'nine' = 9, 'twelve' = 12))
)
column(12,
  radioButtons('tide', label = h3('Tidal range'), choices = c(0.2, 0.4, 0.6, 0.8, 1))
)
```

Column {.tabset}
-------------------------------------

### Correlation plots

```{r}
output$corplo <- renderPlot(corplo(), height = 300, width = 900)
plotOutput('corplo')
```

### Metabolism plots

```{r}
output$metplo <- renderPlot(metplo(), height = 600, width = 900)
plotOutput('metplo')
```

### Summary tables

#### Anomaly summary

```{r}
output$anotab <- renderTable(anotab())
tableOutput('anotab')
```

#### Correlation summary

```{r}
output$cortab <- renderTable(cortab())
tableOutput('cortab')
```

